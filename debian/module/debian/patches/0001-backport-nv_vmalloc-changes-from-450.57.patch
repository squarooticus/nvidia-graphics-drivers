From 52809bc73ce2b45c3a893557178d593f7bb4eed5 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Wed, 26 Aug 2020 18:51:52 +0200
Subject: [PATCH 1/3] backport nv_vmalloc changes from 450.57

---
 common/inc/nv-linux.h |  4 ++++
 conftest.sh           | 20 ++++++++++++++++++++
 nvidia/nvidia.Kbuild  |  1 +
 3 files changed, 25 insertions(+)

diff --git a/common/inc/nv-linux.h b/common/inc/nv-linux.h
index 7661ac7..f960918 100644
--- a/common/inc/nv-linux.h
+++ b/common/inc/nv-linux.h
@@ -509,7 +509,11 @@ extern NvBool nvos_is_chipset_io_coherent(void);
 
 static inline void *nv_vmalloc(unsigned long size)
 {
+#if defined(NV_VMALLOC_HAS_PGPROT_T_ARG)
     void *ptr = __vmalloc(size, GFP_KERNEL, PAGE_KERNEL);
+#else
+    void *ptr = __vmalloc(size, GFP_KERNEL);
+#endif
     if (ptr)
         NV_MEMDBG_ADD(ptr, size);
     return ptr;
diff --git a/conftest.sh b/conftest.sh
index 4545492..b585432 100755
--- a/conftest.sh
+++ b/conftest.sh
@@ -3645,6 +3645,26 @@ compile_test() {
             compile_check_conftest "$CODE" "NV_KTIME_GET_REAL_TS64_PRESENT" "" "functions"
         ;;
 
+        vmalloc_has_pgprot_t_arg)
+            #
+            # Determine if __vmalloc has the 'pgprot' argument.
+            #
+            # The third argument to __vmalloc, page protection
+            # 'pgprot_t prot', was removed by commit 88dca4ca5a93
+            # (mm: remove the pgprot argument to __vmalloc)
+            # in v5.8-rc1 (2020-06-01).
+        CODE="
+        #include <linux/vmalloc.h>
+
+        void conftest_vmalloc_has_pgprot_t_arg(void) {
+            pgprot_t prot;
+            (void)__vmalloc(0, 0, prot);
+        }"
+
+            compile_check_conftest "$CODE" "NV_VMALLOC_HAS_PGPROT_T_ARG" "" "types"
+
+        ;;
+
         # When adding a new conftest entry, please use the correct format for
         # specifying the relevant upstream Linux kernel commit.
         #
diff --git a/nvidia/nvidia.Kbuild b/nvidia/nvidia.Kbuild
index ddc548d..4dd0855 100644
--- a/nvidia/nvidia.Kbuild
+++ b/nvidia/nvidia.Kbuild
@@ -171,6 +171,7 @@ NV_CONFTEST_TYPE_COMPILE_TESTS += node_states_n_memory
 NV_CONFTEST_TYPE_COMPILE_TESTS += kmem_cache_has_kobj_remove_work
 NV_CONFTEST_TYPE_COMPILE_TESTS += sysfs_slab_unlink
 NV_CONFTEST_TYPE_COMPILE_TESTS += proc_ops
+NV_CONFTEST_TYPE_COMPILE_TESTS += vmalloc_has_pgprot_t_arg
 NV_CONFTEST_TYPE_COMPILE_TESTS += timeval
 
 NV_CONFTEST_GENERIC_COMPILE_TESTS += dom0_kernel_present
-- 
2.20.1

