From 98d030d949dcb621052bde88f874639a4e96af09 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Fri, 2 Oct 2020 00:03:05 +0200
Subject: [PATCH 2/6] backport vga_tryget changes from 455.23.04

---
 conftest.sh          | 17 +++++++++++++++++
 nvidia/nv.c          |  2 ++
 nvidia/nvidia.Kbuild |  1 +
 3 files changed, 20 insertions(+)

diff --git a/conftest.sh b/conftest.sh
index a58c1ac..293b552 100755
--- a/conftest.sh
+++ b/conftest.sh
@@ -3717,6 +3717,23 @@ compile_test() {
         }"
             compile_check_conftest "$CODE" "NV_KVMALLOC_PRESENT" "" "functions"
         ;;
+
+        vga_tryget)
+            #
+            # Determine if vga_tryget() is present
+            #
+            # vga_tryget() was removed by commit f369bc3f9096 ("vgaarb: mark
+            # vga_tryget static") in v5.9-rc1 (2020-08-01).
+            #
+            CODE="
+            #include <linux/vgaarb.h>
+            void conftest_vga_tryget(void) {
+                vga_tryget();
+            }"
+
+            compile_check_conftest "$CODE" "NV_VGA_TRYGET_PRESENT" "" "functions"
+        ;;
+
     esac
 }
 
diff --git a/nvidia/nv.c b/nvidia/nv.c
index 56d9836..d8f2606 100644
--- a/nvidia/nv.c
+++ b/nvidia/nv.c
@@ -4145,7 +4145,9 @@ nvidia_probe
 
 #if defined(CONFIG_VGA_ARB) && !defined(NVCPU_PPC64LE)
 #if defined(VGA_DEFAULT_DEVICE)
+#if defined(NV_VGA_TRYGET_PRESENT)
     vga_tryget(VGA_DEFAULT_DEVICE, VGA_RSRC_LEGACY_MASK);
+#endif
 #endif
     vga_set_legacy_decoding(dev, VGA_RSRC_NONE);
 #endif
diff --git a/nvidia/nvidia.Kbuild b/nvidia/nvidia.Kbuild
index 7b38d2d..efea563 100644
--- a/nvidia/nvidia.Kbuild
+++ b/nvidia/nvidia.Kbuild
@@ -159,6 +159,7 @@ NV_CONFTEST_FUNCTION_COMPILE_TESTS += vmf_insert_pfn
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += jiffies_to_timespec
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += ktime_get_raw_ts64
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += ktime_get_real_ts64
+NV_CONFTEST_FUNCTION_COMPILE_TESTS += vga_tryget
 
 NV_CONFTEST_SYMBOL_COMPILE_TESTS += is_export_symbol_gpl_of_node_to_nid
 NV_CONFTEST_SYMBOL_COMPILE_TESTS += is_export_symbol_gpl_sme_active
-- 
2.20.1

