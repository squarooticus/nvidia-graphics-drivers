From c5f761fc57891696e58c39e7004fc8c642bb0419 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Sat, 12 Nov 2022 11:08:57 +0100
Subject: [PATCH] backport find_vma_intersection changes from 450.203.08

---
 nvidia-uvm/uvm8_migrate_pageable.c  | 13 +++++++------
 nvidia-uvm/uvm8_policy.c            |  2 +-
 nvidia-uvm/uvm8_populate_pageable.c |  2 +-
 3 files changed, 9 insertions(+), 8 deletions(-)

diff --git a/nvidia-uvm/uvm8_migrate_pageable.c b/nvidia-uvm/uvm8_migrate_pageable.c
index 39be84b..a33f8a5 100644
--- a/nvidia-uvm/uvm8_migrate_pageable.c
+++ b/nvidia-uvm/uvm8_migrate_pageable.c
@@ -885,13 +885,14 @@ static NV_STATUS migrate_pageable(struct mm_struct *mm,
 
     // VMAs are validated and migrated one at a time, since migrate_vma works
     // on one vma at a time
-    for (; vma && (vma->vm_start <= prev_outer); vma = vma->vm_next) {
+    for (; vma->vm_start <= prev_outer; vma = find_vma_intersection(mm, prev_outer, outer)) {
         unsigned long next_addr = 0;
-        NV_STATUS status = migrate_pageable_vma(vma,
-                                                start,
-                                                outer,
-                                                migrate_vma_state,
-                                                &next_addr);
+        NV_STATUS status;
+
+        // Callers have already validated the range so the vma should be valid.
+        UVM_ASSERT(vma);
+
+        status = migrate_pageable_vma(vma, start, outer, migrate_vma_state, &next_addr);
         if (status == NV_WARN_NOTHING_TO_DO) {
             NV_STATUS populate_status = NV_OK;
 
diff --git a/nvidia-uvm/uvm8_policy.c b/nvidia-uvm/uvm8_policy.c
index 54c1ae2..9452e44 100644
--- a/nvidia-uvm/uvm8_policy.c
+++ b/nvidia-uvm/uvm8_policy.c
@@ -47,7 +47,7 @@ bool uvm_is_valid_vma_range(NvU64 start, NvU64 length)
         if (vma->vm_end >= end)
             return true;
         start = vma->vm_end;
-        vma = vma->vm_next;
+        vma = find_vma_intersection(current->mm, start, end);
     }
 
     return false;
diff --git a/nvidia-uvm/uvm8_populate_pageable.c b/nvidia-uvm/uvm8_populate_pageable.c
index f5d0411..546456d 100644
--- a/nvidia-uvm/uvm8_populate_pageable.c
+++ b/nvidia-uvm/uvm8_populate_pageable.c
@@ -102,7 +102,7 @@ NV_STATUS uvm_populate_pageable(struct mm_struct *mm,
     // VMAs are validated and populated one at a time, since they may have
     // different protection flags
     // Validation of VM_SPECIAL flags is delegated to get_user_pages
-    for (; vma && (vma->vm_start <= prev_outer); vma = vma->vm_next) {
+    for (; vma && vma->vm_start <= prev_outer; vma = find_vma_intersection(mm, prev_outer, outer)) {
         NV_STATUS status = uvm_populate_pageable_vma(vma, start, outer - start, min_prot);
 
         if (status != NV_OK)
-- 
2.20.1

