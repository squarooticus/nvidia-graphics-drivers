From 9d30e34e3da9fec1d716ce14e9a6fd896fa40c4f Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Fri, 7 Apr 2023 12:24:09 +0200
Subject: [PATCH] backport acpi_op_remove changes from 470.182.03

---
 conftest.sh      |  5 +++++
 nvidia/nv-acpi.c | 24 +++++++++++++-----------
 2 files changed, 18 insertions(+), 11 deletions(-)

diff --git a/conftest.sh b/conftest.sh
index 19f83b8..ada78b8 100755
--- a/conftest.sh
+++ b/conftest.sh
@@ -734,6 +734,11 @@ compile_test() {
             # ("ACPI: Remove useless type argument of driver .remove()
             # operation") in v3.9
             #
+            # acpi_op_remove() return type was changed to void by commit
+            # 6c0eb5ba3500 (“ACPI: make remove callback of ACPI driver void”)
+            # in v6.2-rc1 (11-14-2022). NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT
+            # will be undefined for this case.
+            #
             echo "$CONFTEST_PREAMBLE
             #include <linux/acpi.h>
 
diff --git a/nvidia/nv-acpi.c b/nvidia/nv-acpi.c
index 828c314..d6b28d5 100644
--- a/nvidia/nv-acpi.c
+++ b/nvidia/nv-acpi.c
@@ -23,10 +23,12 @@ static NV_STATUS   nv_acpi_extract_object  (const union acpi_object *, void *, N
 
 static int         nv_acpi_add             (struct acpi_device *);
 
-#if !defined(NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT) || (NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT == 2)
-static int         nv_acpi_remove_two_args(struct acpi_device *device, int type);
+#if !defined(NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT)
+static void        nv_acpi_remove(struct acpi_device *device);
+#elif (NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT == 2)
+static int         nv_acpi_remove(struct acpi_device *device, int type);
 #else
-static int         nv_acpi_remove_one_arg(struct acpi_device *device);
+static int         nv_acpi_remove(struct acpi_device *device);
 #endif
 
 static void        nv_acpi_event           (acpi_handle, u32, void *);
@@ -80,11 +82,7 @@ static const struct acpi_driver nv_acpi_driver_template = {
 #endif
     .ops = {
         .add = nv_acpi_add,
-#if !defined(NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT) || (NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT == 2)
-        .remove = nv_acpi_remove_two_args,
-#else
-        .remove = nv_acpi_remove_one_arg,
-#endif
+        .remove = nv_acpi_remove,
 #if defined(NV_ACPI_DEVICE_OPS_HAS_MATCH)
         .match = nv_acpi_match,
 #endif
@@ -338,10 +336,12 @@ static int nv_acpi_add(struct acpi_device *device)
     return 0;
 }
 
-#if !defined(NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT) || (NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT == 2)
-static int nv_acpi_remove_two_args(struct acpi_device *device, int type)
+#if !defined(NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT)
+static void nv_acpi_remove(struct acpi_device *device)
+#elif (NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT == 2)
+static int nv_acpi_remove(struct acpi_device *device, int type)
 #else
-static int nv_acpi_remove_one_arg(struct acpi_device *device)
+static int nv_acpi_remove(struct acpi_device *device)
 #endif
 {
     /*
@@ -392,7 +392,9 @@ static int nv_acpi_remove_one_arg(struct acpi_device *device)
         device->driver_data = NULL;
     }
 
+#if defined(NV_ACPI_DEVICE_OPS_REMOVE_ARGUMENT_COUNT)
     return status;
+#endif
 }
 
 /*
-- 
2.20.1

