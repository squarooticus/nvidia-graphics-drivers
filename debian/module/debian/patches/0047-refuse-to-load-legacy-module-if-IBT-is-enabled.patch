From 9324495060d41737a8a04f2c3fd838d97662cdf7 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Sat, 4 Nov 2023 00:44:56 +0100
Subject: [PATCH] refuse to load legacy module if IBT is enabled

IBT (Indirect Branch Tracking) has been enabled by default (compiled in
everywhere since it is effectively a no-op and enabled at runtime on
supported CPUs, i.e. 11th gen. Intel Core processors (aka Tigerlake) or
newer) since Linux 6.2, it can be disabled by booting with ibt=off.
All entry points reachable from indirect JMP or CALL instructions need
to contain the ENDBR instruction (actually just a NOP that is given a
special meaning by enabling IBT) otherwise the CPU will raise a control
flow exception.

If the BLOB part of the NVIDIA module hasn't been built with IBT
support, the module cannot be used if IBT is active. Check for that
condition and abort module load to avoid kernel errors later.

https://bugs.debian.org/1052069
---
 nv.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/nv.c b/nv.c
index b1aec9b..35307ee 100644
--- a/nv.c
+++ b/nv.c
@@ -716,6 +716,13 @@ int __init nvidia_init_module(void)
     nv_linux_state_t *nvl;
     nv_smu_state_t *nv_smu = &nv_smu_device;
 
+#ifdef CONFIG_X86_KERNEL_IBT
+    if (cpu_feature_enabled(X86_FEATURE_IBT)) {
+        printk(KERN_ERR "NVRM: This NVIDIA driver version is incompatible with IBT. Try booting with ibt=off.");
+        return -EINVAL;
+    }
+#endif
+
     if (NV_BUILD_MODULE_INSTANCES != 0)
     {
         nv_printf(NV_DBG_INFO, "NVRM: nvidia module instance %d\n", 
-- 
2.20.1

