From dc7250b80cf89a6703c1c9df96cbe27cbbdb3c84 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Sun, 19 Sep 2021 15:24:53 +0200
Subject: [PATCH 2/2] backport set_current_state changes from 470.63.01

---
 nvidia/linux_nvswitch.c | 2 +-
 nvidia/nvlink_linux.c   | 2 +-
 nvidia/os-interface.c   | 2 +-
 3 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/nvidia/linux_nvswitch.c b/nvidia/linux_nvswitch.c
index 614a083..1e544f9 100644
--- a/nvidia/linux_nvswitch.c
+++ b/nvidia/linux_nvswitch.c
@@ -2483,7 +2483,7 @@ nvswitch_os_sleep
         // the requested timeout has expired, loop until less
         // than a jiffie of the desired delay remains.
         //
-        current->state = TASK_INTERRUPTIBLE;
+        set_current_state(TASK_INTERRUPTIBLE);
         do
         {
             schedule_timeout(jiffies);
diff --git a/nvidia/nvlink_linux.c b/nvidia/nvlink_linux.c
index 56f629e..cb4ff07 100644
--- a/nvidia/nvlink_linux.c
+++ b/nvidia/nvlink_linux.c
@@ -623,7 +623,7 @@ void NVLINK_API_CALL nvlink_sleep(unsigned int ms)
         // the requested timeout has expired, loop until less
         // than a jiffie of the desired delay remains.
         //
-        current->state = TASK_INTERRUPTIBLE;
+        set_current_state(TASK_INTERRUPTIBLE);
         do
         {
             schedule_timeout(jiffies);
diff --git a/nvidia/os-interface.c b/nvidia/os-interface.c
index 058cf9c..286b900 100644
--- a/nvidia/os-interface.c
+++ b/nvidia/os-interface.c
@@ -699,7 +699,7 @@ NV_STATUS NV_API_CALL os_delay(NvU32 MilliSeconds)
         // the requested timeout has expired, loop until less
         // than a jiffie of the desired delay remains.
         //
-        current->state = TASK_INTERRUPTIBLE;
+        set_current_state(TASK_INTERRUPTIBLE);
         do
         {
             schedule_timeout(jiffies);
-- 
2.20.1

