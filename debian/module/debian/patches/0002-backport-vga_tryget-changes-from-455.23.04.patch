From b0b95aa91390a1285b50dda0621b420180d10002 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Fri, 2 Oct 2020 00:03:05 +0200
Subject: [PATCH 2/7] backport vga_tryget changes from 455.23.04

---
 conftest.sh          | 16 ++++++++++++++++
 nvidia/nv-pci.c      |  2 ++
 nvidia/nvidia.Kbuild |  1 +
 3 files changed, 19 insertions(+)

diff --git a/conftest.sh b/conftest.sh
index b82047a..1e0376b 100755
--- a/conftest.sh
+++ b/conftest.sh
@@ -3769,6 +3769,22 @@ compile_test() {
 
         ;;
 
+        vga_tryget)
+            #
+            # Determine if vga_tryget() is present
+            #
+            # vga_tryget() was removed by commit f369bc3f9096 ("vgaarb: mark
+            # vga_tryget static") in v5.9-rc1 (2020-08-01).
+            #
+            CODE="
+            #include <linux/vgaarb.h>
+            void conftest_vga_tryget(void) {
+                vga_tryget();
+            }"
+
+            compile_check_conftest "$CODE" "NV_VGA_TRYGET_PRESENT" "" "functions"
+        ;;
+
         # When adding a new conftest entry, please use the correct format for
         # specifying the relevant upstream Linux kernel commit.
         #
diff --git a/nvidia/nv-pci.c b/nvidia/nv-pci.c
index 462b523..8bbdea9 100644
--- a/nvidia/nv-pci.c
+++ b/nvidia/nv-pci.c
@@ -405,7 +405,9 @@ nv_pci_probe
 
 #if defined(CONFIG_VGA_ARB) && !defined(NVCPU_PPC64LE)
 #if defined(VGA_DEFAULT_DEVICE)
+#if defined(NV_VGA_TRYGET_PRESENT)
     vga_tryget(VGA_DEFAULT_DEVICE, VGA_RSRC_LEGACY_MASK);
+#endif
 #endif
     vga_set_legacy_decoding(pci_dev, VGA_RSRC_NONE);
 #endif
diff --git a/nvidia/nvidia.Kbuild b/nvidia/nvidia.Kbuild
index 03ad7db..c04f0d6 100644
--- a/nvidia/nvidia.Kbuild
+++ b/nvidia/nvidia.Kbuild
@@ -146,6 +146,7 @@ NV_CONFTEST_FUNCTION_COMPILE_TESTS += vmf_insert_pfn
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += jiffies_to_timespec
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += ktime_get_raw_ts64
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += ktime_get_real_ts64
+NV_CONFTEST_FUNCTION_COMPILE_TESTS += vga_tryget
 
 NV_CONFTEST_SYMBOL_COMPILE_TESTS += is_export_symbol_gpl_of_node_to_nid
 NV_CONFTEST_SYMBOL_COMPILE_TESTS += is_export_symbol_gpl_sme_active
-- 
2.20.1

