From 3417aff83b4ae7b0b148b299e628c52a06d9268f Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Mon, 20 Jun 2022 10:57:03 +0200
Subject: [PATCH 1/3] backport iosys_map changes from 470.129.06

---
 conftest.sh                 |  1 +
 nvidia-drm/nvidia-drm-gem.c | 15 +++++++++++++--
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/conftest.sh b/conftest.sh
index 0bfc7e7..d62b35f 100755
--- a/conftest.sh
+++ b/conftest.sh
@@ -136,6 +136,7 @@ test_headers() {
     FILES="$FILES linux/atomic.h"
     FILES="$FILES linux/dma-map-ops.h"
     FILES="$FILES linux/stdarg.h"
+    FILES="$FILES linux/iosys-map.h"
 
     # Arch specific headers which need testing
     FILES_ARCH="asm/book3s/64/hash-64k.h"
diff --git a/nvidia-drm/nvidia-drm-gem.c b/nvidia-drm/nvidia-drm-gem.c
index e91f170..f1267d4 100644
--- a/nvidia-drm/nvidia-drm-gem.c
+++ b/nvidia-drm/nvidia-drm-gem.c
@@ -59,8 +59,19 @@ void nv_drm_gem_free(struct drm_gem_object *gem)
 
 #if !defined(NV_DRM_DRIVER_HAS_GEM_PRIME_CALLBACKS) && \
     defined(NV_DRM_GEM_OBJECT_VMAP_HAS_MAP_ARG)
+
+/*
+ * The 'dma_buf_map' structure is renamed to 'iosys_map' by the commit
+ * 7938f4218168 ("dma-buf-map: Rename to iosys-map").
+ */
+#if defined(NV_LINUX_IOSYS_MAP_H_PRESENT)
+typedef struct iosys_map nv_sysio_map_t;
+#else
+typedef struct dma_buf_map nv_sysio_map_t;
+#endif
+
 static int nv_drm_gem_vmap(struct drm_gem_object *gem,
-                           struct dma_buf_map *map)
+                           nv_sysio_map_t *map)
 {
     map->vaddr = nv_drm_gem_prime_vmap(gem);
     if (map->vaddr == NULL) {
@@ -71,7 +82,7 @@ static int nv_drm_gem_vmap(struct drm_gem_object *gem,
 }
 
 static void nv_drm_gem_vunmap(struct drm_gem_object *gem,
-                              struct dma_buf_map *map)
+                              nv_sysio_map_t *map)
 {
     nv_drm_gem_prime_vunmap(gem, map->vaddr);
     map->vaddr = NULL;
-- 
2.20.1

