From 8193b22de5852fed4b3780fa3281bb32d9a20454 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Sun, 19 Sep 2021 15:24:53 +0200
Subject: [PATCH 2/2] backport set_current_state changes from 470.63.01

---
 nvidia/nvlink_linux.c | 2 +-
 nvidia/os-interface.c | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/nvidia/nvlink_linux.c b/nvidia/nvlink_linux.c
index dbe2091..6e1c799 100644
--- a/nvidia/nvlink_linux.c
+++ b/nvidia/nvlink_linux.c
@@ -582,7 +582,7 @@ void NVLINK_API_CALL nvlink_sleep(unsigned int ms)
         // the requested timeout has expired, loop until less
         // than a jiffie of the desired delay remains.
         //
-        current->state = TASK_INTERRUPTIBLE;
+        set_current_state(TASK_INTERRUPTIBLE);
         do
         {
             schedule_timeout(jiffies);
diff --git a/nvidia/os-interface.c b/nvidia/os-interface.c
index 3624aa7..67496af 100644
--- a/nvidia/os-interface.c
+++ b/nvidia/os-interface.c
@@ -607,7 +607,7 @@ NV_STATUS NV_API_CALL os_delay(NvU32 MilliSeconds)
         // the requested timeout has expired, loop until less
         // than a jiffie of the desired delay remains.
         //
-        current->state = TASK_INTERRUPTIBLE;
+        set_current_state(TASK_INTERRUPTIBLE);
         do
         {
             schedule_timeout(jiffies);
-- 
2.20.1

