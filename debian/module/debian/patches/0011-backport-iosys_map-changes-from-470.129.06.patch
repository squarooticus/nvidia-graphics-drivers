From d0c4a371f7a1444187f49fadebf48d3b810d78f8 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Mon, 20 Jun 2022 10:57:03 +0200
Subject: [PATCH 1/3] backport iosys_map changes from 470.129.06

---
 conftest.sh                 |  1 +
 nvidia-drm/nvidia-drm-gem.c | 15 +++++++++++++--
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/conftest.sh b/conftest.sh
index 2b52af4..4c8e87e 100755
--- a/conftest.sh
+++ b/conftest.sh
@@ -154,6 +154,7 @@ test_headers() {
     FILES="$FILES asm/pgtable_types.h"
     FILES="$FILES linux/dma-map-ops.h"
     FILES="$FILES linux/stdarg.h"
+    FILES="$FILES linux/iosys-map.h"
 
     translate_and_preprocess_header_files $FILES
 }
diff --git a/nvidia-drm/nvidia-drm-gem.c b/nvidia-drm/nvidia-drm-gem.c
index f3b07f2..d1b7442 100644
--- a/nvidia-drm/nvidia-drm-gem.c
+++ b/nvidia-drm/nvidia-drm-gem.c
@@ -60,8 +60,19 @@ void nv_drm_gem_free(struct drm_gem_object *gem)
 
 #if !defined(NV_DRM_DRIVER_HAS_GEM_PRIME_CALLBACKS) && \
     defined(NV_DRM_GEM_OBJECT_VMAP_HAS_MAP_ARG)
+
+/*
+ * The 'dma_buf_map' structure is renamed to 'iosys_map' by the commit
+ * 7938f4218168 ("dma-buf-map: Rename to iosys-map").
+ */
+#if defined(NV_LINUX_IOSYS_MAP_H_PRESENT)
+typedef struct iosys_map nv_sysio_map_t;
+#else
+typedef struct dma_buf_map nv_sysio_map_t;
+#endif
+
 static int nv_drm_gem_vmap(struct drm_gem_object *gem,
-                           struct dma_buf_map *map)
+                           nv_sysio_map_t *map)
 {
     map->vaddr = nv_drm_gem_prime_vmap(gem);
     if (map->vaddr == NULL) {
@@ -72,7 +83,7 @@ static int nv_drm_gem_vmap(struct drm_gem_object *gem,
 }
 
 static void nv_drm_gem_vunmap(struct drm_gem_object *gem,
-                              struct dma_buf_map *map)
+                              nv_sysio_map_t *map)
 {
     nv_drm_gem_prime_vunmap(gem, map->vaddr);
     map->vaddr = NULL;
-- 
2.20.1

