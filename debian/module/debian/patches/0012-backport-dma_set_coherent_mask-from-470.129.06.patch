From 3151477c12fc4f294b20aecc44c09e3c8852d551 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Mon, 20 Jun 2022 11:14:33 +0200
Subject: [PATCH 2/3] backport dma_set_coherent_mask from 470.129.06

---
 conftest.sh          | 16 ++++++++++++++++
 nvidia/nv.c          |  8 ++++++++
 nvidia/nvidia.Kbuild |  1 +
 3 files changed, 25 insertions(+)

diff --git a/conftest.sh b/conftest.sh
index d62b35f..73f5f2b 100755
--- a/conftest.sh
+++ b/conftest.sh
@@ -4114,6 +4114,22 @@ compile_test() {
             compile_check_conftest "$CODE" "NV_DRM_DEVICE_HAS_PDEV" "" "types"
         ;;
 
+        dma_set_coherent_mask)
+            #
+            # Determine if dma_set_coherent_mask is present
+            #
+            # Added by commit ed6ccf10f24bd (dma-mapping: properly stub out
+            # the DMA API for !CONFIG_HAS_DMA) in 2.6.34
+            #
+            CODE="
+            #include <linux/dma-mapping.h>
+            void conftest_dma_set_coherent_mask(void) {
+                dma_set_coherent_mask();
+            }"
+
+            compile_check_conftest "$CODE" "NV_DMA_SET_COHERENT_MASK_PRESENT" "" "functions"
+        ;;
+
         # When adding a new conftest entry, please use the correct format for
         # specifying the relevant upstream Linux kernel commit.
         #
diff --git a/nvidia/nv.c b/nvidia/nv.c
index 854ff0f..57ba56e 100644
--- a/nvidia/nv.c
+++ b/nvidia/nv.c
@@ -2970,7 +2970,11 @@ nv_set_dma_address_size(
          * minor release update but detect the failure scenario here to prevent
          * an installation regression */
 #if !NV_IS_EXPORT_SYMBOL_GPL_sme_active
+#if defined(NV_DMA_SET_COHERENT_MASK_PRESENT)
+        dma_set_coherent_mask(&nvl->dev->dev, new_mask);
+#else
         pci_set_consistent_dma_mask(nvl->dev, new_mask);
+#endif
 #endif
     }
 }
@@ -4928,7 +4932,11 @@ NvU64 NV_API_CALL nv_get_dma_start_address(
     start = dma_addr & ~(saved_dma_mask);
 
     /* Update the coherent mask to match */
+#if defined(NV_DMA_SET_COHERENT_MASK_PRESENT)
     dma_set_coherent_mask(&dev->dev, dev->dma_mask);
+#else
+    pci_set_consistent_dma_mask(dev, dev->dma_mask);
+#endif
 
 done:
 #endif
diff --git a/nvidia/nvidia.Kbuild b/nvidia/nvidia.Kbuild
index 9ce0097..b605736 100644
--- a/nvidia/nvidia.Kbuild
+++ b/nvidia/nvidia.Kbuild
@@ -168,6 +168,7 @@ NV_CONFTEST_FUNCTION_COMPILE_TESTS += ktime_get_raw_ts64
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += ktime_get_real_ts64
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += vga_tryget
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += iterate_fd
+NV_CONFTEST_FUNCTION_COMPILE_TESTS += dma_set_coherent_mask
 
 NV_CONFTEST_SYMBOL_COMPILE_TESTS += is_export_symbol_gpl_of_node_to_nid
 NV_CONFTEST_SYMBOL_COMPILE_TESTS += is_export_symbol_gpl_sme_active
-- 
2.20.1

