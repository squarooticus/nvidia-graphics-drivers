From 7ec21f7e9309a743cb6523c271af5116b7e406ce Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Sat, 12 Nov 2022 10:06:31 +0100
Subject: [PATCH] backport find_vma_intersection changes from 515.76

---
 nvidia-uvm/uvm_migrate_pageable.c  | 9 +++++++--
 nvidia-uvm/uvm_policy.c            | 2 +-
 nvidia-uvm/uvm_populate_pageable.c | 2 +-
 3 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/nvidia-uvm/uvm_migrate_pageable.c b/nvidia-uvm/uvm_migrate_pageable.c
index d2e3e32..446e58e 100644
--- a/nvidia-uvm/uvm_migrate_pageable.c
+++ b/nvidia-uvm/uvm_migrate_pageable.c
@@ -899,9 +899,14 @@ static NV_STATUS migrate_pageable(migrate_vma_state_t *state)
 
     // VMAs are validated and migrated one at a time, since migrate_vma works
     // on one vma at a time
-    for (; vma->vm_start <= prev_outer; vma = vma->vm_next) {
+    for (; vma->vm_start <= prev_outer; vma = find_vma_intersection(mm, prev_outer, outer)) {
         unsigned long next_addr = 0;
-        NV_STATUS status = migrate_pageable_vma(vma, start, outer, state, &next_addr);
+        NV_STATUS status;
+
+        // Callers have already validated the range so the vma should be valid.
+        UVM_ASSERT(vma);
+
+        status = migrate_pageable_vma(vma, start, outer, state, &next_addr);
         if (status == NV_WARN_NOTHING_TO_DO) {
             NV_STATUS populate_status = NV_OK;
             bool touch = uvm_migrate_args->touch;
diff --git a/nvidia-uvm/uvm_policy.c b/nvidia-uvm/uvm_policy.c
index 4e3da15..933decd 100644
--- a/nvidia-uvm/uvm_policy.c
+++ b/nvidia-uvm/uvm_policy.c
@@ -44,7 +44,7 @@ bool uvm_is_valid_vma_range(struct mm_struct *mm, NvU64 start, NvU64 length)
         if (vma->vm_end >= end)
             return true;
         start = vma->vm_end;
-        vma = vma->vm_next;
+        vma = find_vma_intersection(mm, start, end);
     }
 
     return false;
diff --git a/nvidia-uvm/uvm_populate_pageable.c b/nvidia-uvm/uvm_populate_pageable.c
index bd31e54..8651150 100644
--- a/nvidia-uvm/uvm_populate_pageable.c
+++ b/nvidia-uvm/uvm_populate_pageable.c
@@ -158,7 +158,7 @@ NV_STATUS uvm_populate_pageable(struct mm_struct *mm,
     // VMAs are validated and populated one at a time, since they may have
     // different protection flags
     // Validation of VM_SPECIAL flags is delegated to get_user_pages
-    for (; vma->vm_start <= prev_end; vma = vma->vm_next) {
+    for (; vma && vma->vm_start <= prev_end; vma = find_vma_intersection(mm, prev_end, end)) {
         NV_STATUS status = uvm_populate_pageable_vma(vma, start, end - start, min_prot, touch, populate_permissions);
 
         if (status != NV_OK)
-- 
2.20.1

