From ea835f7c68dc7768d3a0e1f1f9bb5c076b9ebfcd Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Mon, 20 Jun 2022 11:15:34 +0200
Subject: [PATCH 3/3] backport acpi_bus_get_device changes from 470.129.06

---
 conftest.sh          | 16 ++++++++++++++++
 nvidia/nv-acpi.c     | 13 +++++++++++++
 nvidia/nvidia.Kbuild |  1 +
 3 files changed, 30 insertions(+)

diff --git a/conftest.sh b/conftest.sh
index 73f5f2b..0b3f961 100755
--- a/conftest.sh
+++ b/conftest.sh
@@ -4130,6 +4130,22 @@ compile_test() {
             compile_check_conftest "$CODE" "NV_DMA_SET_COHERENT_MASK_PRESENT" "" "functions"
         ;;
 
+        acpi_bus_get_device)
+            #
+            # Determine if the acpi_bus_get_device() function is present
+            #
+            # acpi_bus_get_device() was removed by commit ac2a3feefad5
+            # ("ACPI: bus: Eliminate acpi_bus_get_device()") in
+            # v5.18-rc2 (2022-04-05).
+            #
+            CODE="
+            #include <linux/acpi.h>
+            int conftest_acpi_bus_get_device(void) {
+                return acpi_bus_get_device();
+            }"
+            compile_check_conftest "$CODE" "NV_ACPI_BUS_GET_DEVICE_PRESENT" "" "functions"
+        ;;
+
         # When adding a new conftest entry, please use the correct format for
         # specifying the relevant upstream Linux kernel commit.
         #
diff --git a/nvidia/nv-acpi.c b/nvidia/nv-acpi.c
index dd11109..7bf464c 100644
--- a/nvidia/nv-acpi.c
+++ b/nvidia/nv-acpi.c
@@ -629,8 +629,10 @@ static void nv_uninstall_notifier(nv_acpi_t *pNvAcpiObject, acpi_notify_handler
 
 void NV_API_CALL nv_acpi_methods_init(NvU32 *handlesPresent)
 {
+#if defined(NV_ACPI_BUS_GET_DEVICE_PRESENT)
     struct acpi_device *device = NULL;
     int retVal = -1;
+#endif
 
 
     if (!handlesPresent) // Caller passed us invalid pointer.
@@ -642,6 +644,7 @@ void NV_API_CALL nv_acpi_methods_init(NvU32 *handlesPresent)
     NV_ACPI_WALK_NAMESPACE(ACPI_TYPE_DEVICE, ACPI_ROOT_OBJECT,
                         ACPI_UINT32_MAX, nv_acpi_find_methods, NULL, NULL);
 
+#if defined(NV_ACPI_BUS_GET_DEVICE_PRESENT)
     if (nvif_handle)
     {
         *handlesPresent = NV_ACPI_NVIF_HANDLE_PRESENT;
@@ -670,6 +673,7 @@ void NV_API_CALL nv_acpi_methods_init(NvU32 *handlesPresent)
 
         } while (0);
     }
+#endif
 
     if (wmmx_handle)
         *handlesPresent = *handlesPresent | NV_ACPI_WMMX_HANDLE_PRESENT;
@@ -677,6 +681,8 @@ void NV_API_CALL nv_acpi_methods_init(NvU32 *handlesPresent)
         *handlesPresent = *handlesPresent | NV_ACPI_MXMI_HANDLE_PRESENT;
     if (mxms_handle)
         *handlesPresent = *handlesPresent | NV_ACPI_MXMS_HANDLE_PRESENT;
+
+#if defined(NV_ACPI_BUS_GET_DEVICE_PRESENT)
     if (psr_handle)
     {
         // Since _PSR is not a per-GPU construct we only need to register a
@@ -692,6 +698,7 @@ void NV_API_CALL nv_acpi_methods_init(NvU32 *handlesPresent)
             }
         }
     }
+#endif
 
     return;
 }
@@ -756,9 +763,11 @@ void NV_API_CALL nv_acpi_methods_uninit(void)
     if (nvif_parent_gpu_handle == NULL) 
         return;
 
+#if defined(NV_ACPI_BUS_GET_DEVICE_PRESENT)
     acpi_bus_get_device(nvif_parent_gpu_handle, &device);
 
     nv_uninstall_notifier(device->driver_data, nv_acpi_event);
+#endif
 
     device->driver_data = NULL;
     nvif_parent_gpu_handle = NULL;
@@ -1318,7 +1327,11 @@ NV_STATUS NV_API_CALL nv_acpi_ddc_method(
     if (!dev_handle)
         return NV_ERR_INVALID_ARGUMENT;
 
+#if defined(NV_ACPI_BUS_GET_DEVICE_PRESENT)
     status = acpi_bus_get_device(dev_handle, &device);
+#else
+    return NV_ERR_NOT_SUPPORTED;
+#endif
 
     if (ACPI_FAILURE(status) || !device)
         return NV_ERR_INVALID_ARGUMENT;
diff --git a/nvidia/nvidia.Kbuild b/nvidia/nvidia.Kbuild
index b605736..eac42be 100644
--- a/nvidia/nvidia.Kbuild
+++ b/nvidia/nvidia.Kbuild
@@ -169,6 +169,7 @@ NV_CONFTEST_FUNCTION_COMPILE_TESTS += ktime_get_real_ts64
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += vga_tryget
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += iterate_fd
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += dma_set_coherent_mask
+NV_CONFTEST_FUNCTION_COMPILE_TESTS += acpi_bus_get_device
 
 NV_CONFTEST_SYMBOL_COMPILE_TESTS += is_export_symbol_gpl_of_node_to_nid
 NV_CONFTEST_SYMBOL_COMPILE_TESTS += is_export_symbol_gpl_sme_active
-- 
2.20.1

